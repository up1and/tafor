.. _guide:

使用指南
=================================

主界面
----------

总览
^^^^^^^^^^^

.. image:: /images/main.png

主界面有四个标签页，分别对应着不同的数据展示：

- **RECENT** 仅显示每一个类别中 24 小时内的最新报文
- **TAF** 以表格的形式展示历史预报报文，包含数据源查询状态
- **METAR** 以表格的形式展示历史观测
- **SIGMET** 以表格的形式展示历史重要气象情报


数据展示
^^^^^^^^^^^

.. image:: /images/taf_table.png

表格数据每一页显示 12 条，其中 SIGMET 每页展示 6 条，双击表格区域可以复制报文内容。

表格数据中只有 TAF 标签页有查询一栏，``绿色对勾`` 代表发送的报文已和远程数据源对比，数据一致，``红色叉`` 代表发送的报文远程数据源还没有查到或者远程数据源和本地发出的报文数据不一致。

表格左下角 ``红色重复图标`` 为重发报按钮，仅适用与 TAF 报文，且发布时间不超过 6 个小时的报文。

表格右下角 ``蓝色箭头`` 为翻页按钮。

表格右下角搜索框支持按日期过滤报文，如 `2018/03/17`，查询当日报文。

.. note:: TAF 报文在发送后没有出现绿色对勾的标志，请务必检查报文是否正确发出。


设置
----------

常规
^^^^^^^^^^^

.. image:: /images/general_settings.png

通用
""""""""""""
- **开机自动启动** 程序在系统启动时自动启动
- **总是显示报文编辑器** 报文发送窗口打开时报文编辑器会默认隐藏，勾选后同时显示报文编辑器和发送窗口
- **调试模式** 勾选后用于开启低级别的日志记录模式
- **大号字体** 界面显示更换大号字体，重启后生效

校验
""""""""""""
用于开启或者关闭 TAF 报文验证的阈值。

备份
""""""""""""
设置导入导出支持 JSON 格式的配置文件，部分配置样例如下。

.. code-block:: json

    {
      "Message/ICAO":"ZJHK",
      "Monitor/WebApiURL":"https://tafor.herokuapp.com/remote/latest/zjhk.json",
      "Communication/SerialPort":"COM1",
      "Message/WeatherWithIntensity":"[\"RA\", \"SHRA\", \"TSRA\", \"SHGRRA\"]",
      "General/Debug":"true"
    }

载入配置文件时，先点击 ``浏览`` 选择配置文件，再点击 ``导入`` 按钮。

备份配置文件时，先点击 ``浏览`` 选择导出目录，再点击 ``导出`` 按钮。

.. note:: 导入配置文件后会覆盖本机当前设置，使用时请注意备份好数据。


报文参数
^^^^^^^^^^^

.. image:: /images/message_settings.png

报文前缀
""""""""""""

- **机场代码** 本地机场的 ICAO 机场代码，如 ZJHK
- **情报区域** 本地机场的区域和公报编号，如 CI35
- **监视台责任区** 用于发布 SIGMET 的关键参数，比如 ZJSA SANYA FIR，不是气象监视台可以忽略
- **趋势识别码** 观测发报软件能够识别的趋势预报前缀字符，根据具体情况设定


天气现象备案
""""""""""""

天气现象的添加分为两组，有强度变化的和无强度变化的，有强度变化的天气现象无需再添加强度符号。

天气现象之间的顺序可以通过拖动后改变。

天气现象只能添加行业标准里有的天气现象，不能添加奇怪的字符，字符必须大写。

.. note:: 天气现象有变更需要重新启动才能生效。


通信参数
^^^^^^^^^^^
.. image:: /images/communication_settings.png

串口参数
""""""""""""
串口参数请根据实际环境填写，用于和本机电流环通信。


AFTN 参数
""""""""""""
- **线路冠字** AFTN 线路的 Channel
- **流水号** 当日此线路发送的报文序号，世界时日届流水号会重置为 1
- **用户单位** 报文的发电源头
- **地址上限** AFTN 转报机一份报文允许最大的地址上限，通常一份报文支持 21 个地址，最多 3 行地址，每行不超过 7 个地址
- **行字符上限** AFTN 转报机所支持的每一行最大的字符数，通常不超过 69 个字符

.. note:: AFTN 参数的配置请以实际环境为主，参数的不同会影响到最终发送的报文段行不同。


发报地址
""""""""""""
不同类别的报文有不同的发报地址，多个发报地址请以空格隔开。


监控及告警
^^^^^^^^^^^

.. image:: /images/monitor_settings.png

数据源
""""""""""""
软件会定时请求数据源，获取报文信息或者情报区信息等。

**报文请求地址**

程序每分钟会请求远程数据源，使用 `HTTP GET` 的方式。

接口定义的返回数据如下：

.. code-block:: json

    {
      "FC": "TAF ZJHK 220414Z 220615 04004MPS 6000 BKN007 BKN020 TX22/06Z TN19/15Z=",
      "FT": "TAF ZJHK 220316Z 220606 04004MPS 4000 BR BKN007 BKN020 TX25/06Z TN19/21Z BECMG 0102 BKN015 BKN030=",
      "SA": "METAR ZJHK 220500Z 02004MPS 340V060 8000 BKN007 OVC023 20/19 Q1015 NOSIG="
    }


**情报区信息地址**

程序会每 10 分钟请求一次情报区信息，同样使用 `HTTP GET` 的方式。

接口定义的返回数据如下：

.. code-block:: json

    {
      "boundaries": [], 
      "coordinates": [
        [
          105, 
          25
        ], 
        [
          120, 
          10
        ]
      ], 
      "image": "https://tafor.herokuapp.com/static/cloud.jpg", 
      "rect": [
        15, 
        50, 
        260, 
        260
      ], 
      "size": [
        376, 
        376
      ]
    }


- **boundaries** 情报区的边界，用一组点表示
- **coordinates** 卫星云图的经纬度坐标范围，标记左上角到右下角两个点，用十进制经度，纬度表示
- **image** 当前时刻最新的卫星云图地址
- **rect** SIGMET 编辑区域显示的区域大小和位置，前两个参数表示区域的起始点 x、y，后两个参数表示区域的宽和高，单位像素
- **size** 卫星云图的宽和高，单位像素


电话服务
""""""""""""
电话服务同样需要搭建一个独立的接口。

程序会使用 ``HTTP BASIC AUTH`` 的方式向指定的地址发送 ``POST`` 请求，Python 示例如下：

.. code-block:: python

    requests.post(url, auth=('api', token), data={'mobile': mobile})

- **url** 请求电话拨号服务的地址
- **token** 用于认证用户身份的密钥
- **mobile** 所要呼叫的手机号

.. note:: 认证 Token 需要电话服务网站注册账号后生成。


迟发监控
""""""""""""
监控 TAF 报文的正常发布情况，只关注正常报，默认以声音的方式返回告警。

告警时间填写范围 0 - 50，默认值为30，时间单位为分钟。


.. note:: 举例 FC0312 发报时间为 01:00 - 01:50 之间，如果设置告警时间为 30，再 01:30 之后如果 FC0312 报文还未正常发出，警告就会触发。


声音提醒和音量
"""""""""""""""
**预报**

整点发报时间之后的 5 分钟，会弹出闹钟提醒发报，闹钟有贪睡和关闭功能，贪睡的功能为 5 分钟后再此提醒你。

如果在此期间，报文已经成功发布并且远程数据源也已确认，该时次闹钟不会再响起。


**趋势**

趋势预报的提醒主要以嘀嗒的声音为主，触发时间范围为正点的前两分钟到整点。


**重要气象情报**

每次发完一种类型的重要气象情报后会自动添加一个闹钟，在重要气象情报有效期结束前 20 分钟时闹钟响起，提醒你是否需要继续发布重要气象情报。

取消报不会自动添加闹钟。


.. note:: 部分配置更改如需生效，需要重启软件。


TAF 报文的编辑
--------------

编辑
^^^^^^^^^^^

.. image:: /images/taf_editor.png

编辑框严格限制了每项要素所能输入的字符，未输入完全的项会灰色显示。

阵风、能见度、温度的输入需要手动补 0，比如阵风 9 m，需要输入 09，所有必要项输入完全后，才可以进行下一步。

.. note:: FM 组暂时没有。


预览和校验
^^^^^^^^^^^

.. image:: /images/taf_preview.png


预报报文校验可以实现复杂逻辑的校验，比如 TEMPO 跨越多个 BECMG 组的检验。

预报报文转折逻辑有误，会用红色高亮显示，单项要素之间的转折判断不会标注不符合规则的原因，只有涉及多项要素之间的组合才会有文字提示。

如果报文没有通过预设校验依旧可以发布报文，但会有二次确认对话框。


重发
^^^^^^^^^^^
有时异常情况，报文并没有正常发送需要重新发布。

.. image:: /images/resend.png

在 TAF 历史记录中，点击没有正常发送的报文，左下角会出现 ``红色重复图标``，可以选择重新发送此报文。


趋势报文的编辑
-----------------

.. image:: /images/trend_editor.png


趋势预报选择 FM、TL、AT 时间组时，只能提前 150 分钟添加。

首页会显示最近一次发布的趋势预报，如果最后一条记录是 NOSIG，则不会显示趋势相关信息。


SIGMET 报文的编辑
-------------------
模板
^^^^^^^^^^^

通用模板
"""""""""""""""
.. image:: /images/sigmet_general_template.png

通用模板适用于快速编辑雷暴、积冰、颠簸的重要气象情报。

报文的起始时间、结束时间、发布序号会自动生成。

天气区域的选择推荐使用点坐标的方式，最大支持 7 个点，虚线表示正在编辑，实线表示编辑完成：

    * :kbd:`鼠标左键` 添加坐标点

    * :kbd:`鼠标右键` 删除上一个点

    * 在已有两个点时，在初始点附近点击可以形成实线闭合区域，表示编辑完成

    * 在编辑完成时，程序会自动计算所选区域和情报区边界的交集


.. note:: 通用模板不支持多块区域的编辑，如有需要请选择自定义的方式编辑。

热带气旋模板
"""""""""""""""
.. image:: /images/sigmet_typhoon_template.png

经纬度的输入需要自行添加标识符 N、E 等。

预测时间默认为有效结束时前之前的整点。

预测经纬度会根据当前的经纬度、移动速度、移动时间差值计算未来的经纬度，已考虑不同纬度每度经度所表示的距离不同。

.. note:: 移动时间优先选取 预测时间 - 观测时间，如果没有观测时间，则用 预测时间 - 起始时间 代替。

自定义
^^^^^^^^^^^
如果模板不满足当前的编辑需求，可以尝试使用自定义的方式。

.. image:: /images/custom_sigmet.png

文本框只需要输入报文的正文内容，结尾有无 ``=`` 皆可。

自定义编辑会默认载入上一次发布的同类型报文，取消报会忽略。

.. note:: 如果删去文本框的内容，会有同类型的 SIGMET 模板提示。


取消报
^^^^^^^^^^^
.. image:: /images/cancel_sigmet.png

如果有需要取消的报文，取消报会填入。

取消信息的结束时间会和报头的结束时间一致。


预览
^^^^^^^^^^^
.. image:: /images/sigmet_preview.png

SIGMET 的预览会检查字符是否符合行业标准，但不检查逻辑准确性，如果出现标红字体请仔细检查，并确认发布。

